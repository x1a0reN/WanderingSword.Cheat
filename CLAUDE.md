
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a cheat/internal mod for the game "逸剑风云决" (Wandering Sword) V1.24.32. It uses DLL injection via version.dll proxy hijacking combined with Unreal Engine 4 SDK to create an in-game cheat menu by hijacking the game's built-in settings panel.

## Build Commands

```bash
# Build the DLL
cd Inject
"/d/Program Files/Visual Studio 2026/MSBuild/Current/Bin/MSBuild.exe" Wandering_Sword_Inject.vcxproj //t:Build //p:Configuration=Release //p:Platform=x64 //m:1
```

Output: `Injectd\Release\Wandering_Sword_Inject.dll`

## Architecture

### Injection Flow
1. `DllMain` → `CreateThread(MainThread)`
2. `MainThread`: Allocate console → Hook GVC PostRender VTable → Key loop
3. `HookedGVCPostRender`: Per-frame execution, handles HOME key toggle, button click detection

### Core Hooks
- **GVC PostRender Hook**: VTable hook on `UGameViewportClient::PostRender` at index `Offsets::GVCPostRenderIdx`
- Used for per-frame logic (key detection, UI state sync)

### Panel Lifecycle
``` id="9vycfd"
HOME pressed → ToggleInternalWidget()
  ├─ Show: CreateInternalWidgetInstance() → AddToViewport → InitializeConfigView2BySDK → ApplyConfigView2TextPatch → SetGamePaused(true)
  └─ Hide: RemoveFromParent() → SetGamePaused(false) → Cleanup cache
```

## Key Source Files

| File | Purpose |
|------|---------|
| `Inject/Main.cpp` | Entry point, DLL main, key handling loop |
| `Inject/FrameHook.cpp` | GVC PostRender hook, UI polling |
| `Inject/TabContent.cpp` | Tab UI content (Tab0 character editing, Tab1 items) |
| `Inject/WidgetFactory.cpp` | UI widget creation helpers |
| `Inject/PanelManager.cpp` | Panel lifecycle management |
| `Inject/CheatState.cpp` | Cheat state persistence |

## Important Patterns

### SDK Usage
- Use SDK member functions (e.g., `GetOptionCount()`, `GetSelectedIndex()`) instead of raw memory access
- UE4 SDK classes are in `SDK/` directory (generated by Dumper-7)

### UI Controls
- **Dropdown**: `UBPVE_JHConfigVideoItem2_C` (CB_Main ComboBox + TXT_Title)
- **Slider**: `UBPVE_JHConfigVolumeItem2_C` (VolumeSlider + BTN_Minus/Plus + TXT_CurrentValue)
- **Toggle**: Dropdown with options "关/开" (no CheckBox in SDK)

### Performance Considerations
- Use throttled polling (100ms interval) for slider/dropdown detection
- Use focus caching to reduce per-frame keyboard focus scans
- Tab0 character editing uses `PollTab0CharacterInput` with various polling optimizations

## Hotkeys
- **HOME**: Toggle cheat menu display/hide
- **DELETE**: Unload DLL

## Important Notes
- The project uses Chinese comments and output
- 进度.md contains detailed development progress and pitfalls
- 轮询点与掉帧分析.md contains performance analysis for UI polling

## New Rules

1. **Never Delete Any Files**: Under no circumstances shall any file be deleted or commands executed that would result in file deletion.
2. **Compile After Code Modifications**: Every time code modifications are made, the following compile command must be executed:
   ```bash
   & 'D:\Program Files\Visual Studio 2026\MSBuild\Current\Bin\MSBuild.exe' 'D:\Projects\WanderingSword.Cheat\Inject\Wandering_Sword_Inject.vcxproj' /t:Build /p:Configuration=Release /p:Platform=x64 /m:1
   ```
   If a DLL is being used and an error occurs stating that the DLL is occupied, stop the process and notify me.
3. **Automatic Chinese GitHub Commit**: After modifying any code, automatically submit a commit to GitHub in Chinese. **Do not include a signature in the commit.**
4. **Do Not Modify Existing Correct Code**: Do not modify previously correct code unless necessary for implementing a new feature. If modification of existing code is required, it must be explicitly mentioned, as changes could potentially introduce errors in previously correct functionality.
